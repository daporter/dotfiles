#!/bin/sh

PIPE=/tmp/dwmbar

if [ ! -p $PIPE ]; then
	mkfifo $PIPE
fi

# Ensure the pipe is removed when we exit.
trap "rm -f $PIPE" EXIT INT TERM

mail() {
	count=$(notmuch count 'tag:unread NOT tag:archived')
	if [ "$count" = '0' ]; then
		icon=''
	else
		icon=''
	fi
	printf "mail:%s\n" "$icon $count"
}

cpu() {
	data=$(grep --only-matching "^[^ ]*" /proc/loadavg)
	printf "cpu:%s\n" " $data"
}

mem() {
	data=$(free | awk '/^Mem:/ {printf "%d%%\n", int($3) / int($2) * 100}')
	printf "mem:%s\n" " $data"
}

volume() {
	data=$(pamixer --get-volume-human)
	printf "volume:%s\n" " $data"
}

date_time() {
	data=$(date '+%a %e %b %R')
	printf "date_time:%s\n" " $data"
}

wifi() {
	data=$(nmcli dev wifi | awk '/^\*/ {printf "%s %s%%\n", $3, $8}')
	printf "wifi:%s\n" " $data"
}

if [ "$(hostname)" = 'zwolle' ]; then
	while :; do mail;      sleep 300s; done > "$PIPE" &
fi
while :; do cpu;       sleep  30s; done > "$PIPE" &
while :; do mem;       sleep  20s; done > "$PIPE" &
while :; do volume;    sleep   5s; done > "$PIPE" &
while :; do wifi;      sleep  10s; done > "$PIPE" &
while :; do date_time; sleep  60s; done > "$PIPE" &

while read -r line; do
	case $line in
		mail*)
			mail_s=${line#mail:}
			;;
		cpu*)
			cpu_s=${line#cpu:}
			;;
		mem*)
			mem_s=${line#mem:}
			;;
		volume*)
			volume_s=${line#volume:}
			;;
		wifi*)
			wifi_s=${line#wifi:}
			;;
		date_time*)
			date_time_s=${line#date_time:}
			;;
		*)
			;;
	esac

	status="$cpu_s  $mem_s  $volume_s  $wifi_s  $date_time_s"
	if [ "$(hostname)" = 'zwolle' ]; then
		status="$mail_s  $status"
	fi
	xsetroot -name " $status"

done < $PIPE
