#!/bin/sh

. "$HOME"/.rc.d/join.sh

PIPE=/tmp/dwmbar

if [ ! -p $PIPE ]; then
	mkfifo $PIPE
fi

# Ensure the pipe is removed when we exit.
trap "rm -f $PIPE" EXIT INT TERM

mail() {
	count=$(notmuch count 'tag:unread NOT tag:archived')
	if [ "$count" = '0' ]; then
		icon=
	else
		icon=
	fi
	printf "mail:%s\n" "$icon $count"
}

volume() {
	data=$(pamixer --get-volume-human)
	printf "volume:%s\n" "  $data"
}

cpu() {
	data=$(grep --only-matching "^[^ ]*" /proc/loadavg)
	printf "cpu:%s\n" "  $data"
}

mem() {
	data=$(free | awk '/^Mem:/ {printf "%d%%\n", int($3) / int($2) * 100}')
	printf "mem:%s\n" "  $data"
}

wifi() {
	data=$(awk 'NR==3 {printf("%.0f%%", $3*10/7)}' /proc/net/wireless)
	network=$(iwctl station wlan0 show | awk '/Connected network/ {print $3}')
	if [ -n "$data" ]; then
		printf "wifi:%s\n" "  $data $network"
	else
		printf "wifi:%s\n" "睊"
	fi
}

date_time() {
	data=$(date '+%a %d %b %R')
	printf "date_time:%s\n" "  $data"
}

# if [ "$(hostname)" = 'zwolle' ]; then
# 	while :; do mail;  sleep 300s; done > "$PIPE" &
# fi
while :; do volume;    sleep   5s; done > "$PIPE" &
while :; do cpu;       sleep  30s; done > "$PIPE" &
while :; do mem;       sleep  20s; done > "$PIPE" &
while :; do wifi;      sleep  10s; done > "$PIPE" &
while :; do date_time; sleep  60s; done > "$PIPE" &

while read -r line; do
	case $line in
# 		mail*)
# 			mail_s=${line#mail:}
# 			;;
		volume*)
			volume_s=${line#volume:}
			;;
		cpu*)
			cpu_s=${line#cpu:}
			;;
		mem*)
			mem_s=${line#mem:}
			;;
		wifi*)
			wifi_s=${line#wifi:}
			;;
		date_time*)
			date_time_s=${line#date_time:}
			;;
		*)
			;;
	esac

	status=$(join '  |  ' "$volume_s" "$cpu_s" "$mem_s" "$wifi_s" "$date_time_s")
#	if [ "$(hostnamectl hostname)" = 'zwolle' ]; then
#       status=$(join $mail_s $volume_s $cpu_s $mem_s $wifi_s $date_time_s '  |  ')
#	fi
	xsetroot -name "  $status "

done < $PIPE
