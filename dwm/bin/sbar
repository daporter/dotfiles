#!/bin/env sh

update_cpu () {
	cpu="Ôë©  $(grep -o "^[^ ]*" /proc/loadavg )"
}

update_memory () {
	memory="Óâ¶  $(free -h | awk '(NR==2){ print $4 }')"
}


update_disk () {
	disk="Û∞ãä $(df -h | awk '{ if ($6 == "/") print $4 }')"
}

update_time () {
	time="ÔÅ≥  $(date "+%a %d %b %R")"
}

update_bat () {
	read -r bat_capacity </sys/class/power_supply/BAT0/capacity
	bat="Û∞Åπ $bat_capacity%"
}

calc_net_traffic () {
	cache=/tmp/sbar-${1##*/}
	if [ -r "$cache" ]; then
		read -r old < "$cache"
	else
		old=0
	fi
	read -r new < "$1"
	printf %d\\n "$new" > "$cache"
	speed=$(echo "scale=1; ($new - $old) / 1024" | bc)
	if [ "$(echo "$speed > 1024" | bc)" = 1 ]; then
		speed=$(echo "scale=1; $speed / 1024" | bc)
		printf '%5.1fM' "$speed"
	else
		printf '%5.1fK' "$speed"
	fi
}

update_net_traffic () {
	rx=$(calc_net_traffic /sys/class/net/wlan0/statistics/rx_bytes)
	tx=$(calc_net_traffic /sys/class/net/wlan0/statistics/tx_bytes)
	net_traf="$rxü†ã $txü†â"
}

update_wifi () {
	data=$(awk 'NR==3 {printf("%.0f%%", $3*10/7)}' /proc/net/wireless)
	network=$(iwctl station wlan0 show | awk '/Connected network/ {print $3}')
	if [ -n "$data" ]; then
		wifi="Ôá´  $data $network"
	else
		wifi="Ô™©"
	fi
}

update_vol () {
	if [ "$(pamixer --get-mute)" = false ]; then
		vol="üîä $(pamixer --get-volume)%"
	else
		vol="üîá 0%"
	fi
}

display () {
	xsetroot -name " $net_traf   $cpu   $memory   $disk   $bat   $vol   $wifi   $time "
}

# Initialisation.

printf %s "$$" > ~/.cache/sbar.pid
sec=0

# Signals.

# To update a module from an external command, send a signal:
#
#   $ kill -m "$(cat ~/.cache/pidofbar)"
#
# where m = 34+n

# trap	"<function>;display"		"RTMIN+n"
trap	"update_vol;display"		"RTMIN"
trap	"update_bat;display"		"RTMIN+1"

# Run all modules immediately on startup to set initial values.
update_net_traffic
update_cpu
update_memory
update_disk
update_bat
update_vol
update_wifi
update_wifi
update_time
display

while true
do
	sleep 1 & wait && {
		# Update a module every n seconds with an offset of m.
		#   [ $((sec % n)) -eq m ] && udpate_item

		update_net_traffic      # update every second

		[ $((sec %  2)) -eq 0 ] && display

		[ $((sec % 15)) -eq 0 ] && update_cpu
		[ $((sec % 15)) -eq 1 ] && update_memory
		[ $((sec % 30)) -eq 2 ] && update_time
		[ $((sec % 30)) -eq 3 ] && update_wifi
		[ $((sec % 60)) -eq 4 ] && update_bat
		[ $((sec % 60)) -eq 5 ] && update_disk

		sec=$((sec + 1))
	}
done
