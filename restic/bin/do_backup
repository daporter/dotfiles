#!/usr/bin/env bash
#
# Run a backup of my home directory.

set -o errexit                  # abort on nonzero exitstatus
set -o nounset                  # abort on unbound variable
set -o pipefail                 # don't hide errors within pipes

# Check if already mounted
if ! mountpoint -q "$RESTIC_REPOSITORY"; then
	echo "Mounting restic drive..."
	sudo mount "$RESTIC_REPOSITORY"
	sleep 5						# give the drive a few seconds to spin up
fi

if ! restic backup "$HOME"                                    \
	 --exclude-file="$HOME/.config/restic/restic-exclude.txt" \
	 --no-scan                                                \
	 --quiet ; then
	echo 'Unable to perform backup. Exiting.'
	exit 1
fi

# Keep the most recent 7 daily snapshots, then 4 (remember, 7 dailies already
# include a week!) last-day-of-the-weeks and 11 or 12 last-day-of-the-months (11
# or 12 depends if the 5 weeklies cross a month). And finally 100
# last-day-of-the-year snapshots. All other snapshots are removed.
if ! restic forget      \
	 --keep-daily 7     \
	 --keep-weekly 5    \
	 --keep-monthly 12  \
	 --keep-yearly 100  \
	 --cleanup-cache    \
	 --prune            \
	 --quiet ; then
	echo 'Unable to remove old snapshots.'
	exit 1
fi

echo "Backup complete."
