#!/bin/sh
#
# Run a backup of my home directory.

_wifi () {
	echo '* Connecting to network Phunculist'
	if ! nmcli connection up Phunculist; then
		echo 'Unable to connect to network Phunculist. Exiting.'
		exit 1
	fi
}

_prepare () {
	. "$HOME"/.profile.d/restic.sh
}

_do_backup () {
	echo '* Performing backup'
	exclude=$HOME/.config/restic/restic-exclude.txt
	if ! restic --exclude-file="$exclude" backup "$HOME"; then
		echo 'Unable to perform backup. Exiting.'
		exit 1
	fi
	echo
}

_remove_old_snapshots () {
	echo '* Removing old snapshots'
	# Keep the most recent 7 daily snapshots, then 4 (remember, 7
	# dailies already include a week!) last-day-of-the-weeks and 11 or
	# 12 last-day-of-the-months (11 or 12 depends if the 5 weeklies
	# cross a month). And finally 100 last-day-of-the-year
	# snapshots. All other snapshots are removed.
	if ! restic forget \
	     --keep-daily 7 \
	     --keep-weekly 5 \
	     --keep-monthly 12 \
	     --keep-yearly 100 \
	     --prune; then
		echo 'Unable to remove old snapshots.'
		exit 1
	fi
}

echo ⸻⸻⸻⸻⸻⸻⸻⸻⸻⸻⸻⸻⸻⸻⸻⸻⸻⸻⸻⸻ Backup started: "$(date '+%a %H:%M')" ⸻⸻⸻⸻⸻⸻⸻⸻⸻⸻⸻⸻⸻⸻⸻⸻⸻⸻⸻⸻
_wifi && _prepare && _do_backup && _remove_old_snapshots
echo ⸻⸻⸻⸻⸻⸻⸻⸻⸻⸻⸻⸻⸻⸻⸻⸻⸻⸻⸻⸻ Backup finished: "$(date '+%a %H:%M')" ⸻⸻⸻⸻⸻⸻⸻⸻⸻⸻⸻⸻⸻⸻⸻⸻⸻⸻⸻
