#!/usr/bin/env bash

# Rofi (or dmenu) interface for session actions
# ======================================================================

_pkill() {
	if pgrep -x "$1"; then
		pkill -x "$1"
	fi
}

_kill_processes() {
	_pkill bspwm_external_rules
	_pkill sxhkd
	_pkill melonpanel
	_pkill feh
	_pkill xcompmgr
}

_checkdep() {
	command -v "$1" >/dev/null || return 1
}

_dynamic_menu() {
	if _checkdep rofi; then
		# use printf to output array items on a new line
		rofi -dmenu -i -no-custom -p 'Power options'
	elif _checkdep dmenu; then
		dmenu -i -p 'Power options'
	else
		echo "Missing rofi or dmenu dependency." && exit 1
	fi
}

# Possible actions
actions=('Suspend'
	'Log out'
	'Reboot'
	'Power off'
	'Xmodmap and keyboard reload'
	'Configure anew BSPWM monitors/desktops')

# List actions to choose from.  Output array items on a new line.
_list_actions() {
	printf '%s\n' "${actions[@]}" | _dynamic_menu
}

choice="$(_list_actions)"

# Run the selected command.
case "$choice" in
	S*) zzz ;;
	L*) _kill_processes && bspc quit ;;
	R*) _kill_processes && doas reboot ;;
	P*) _kill_processes && doas halt ;;
	X*) _kbd_reset_and_xmodmap ;;
	C*) bspwm_conf_reset_monitors ;;
esac
