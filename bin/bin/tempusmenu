#!/usr/bin/env bash

# tempusmenu --- dmenu-style interface for `tempus`.
# ======================================================================

if ! command -v rofi >/dev/null; then
	echo "Missing rofi dependency."
	return 1
fi

_check_dirs() {
	if [ ! -d "$1" ]; then
		echo "Missing path to Tempus theme directories."
		exit 1
	fi
}

_check_files() {
	if [ ! -f "$1" ]; then
		echo "Missing path to Tempus theme files."
		exit 1
	fi
}

tempus_files="$HOME"/.local/share/my_colours
tempus_shell_files="$tempus_files"/shell/
tempus_active="$tempus_files"/active-theme.sh

_check_dirs "$tempus_files"
_check_dirs "$tempus_shell_files"
_check_files "$tempus_active"

# Get the unique identity of the active theme.  We want to inform the
# user about it in the `rofi' prompt.
tempus_active_name=$(sed '/tempus_/!d ; s,.*/,,' "$tempus_active")
tempus_active_id="${tempus_active_name%.sh}"
tempus_active_id="${tempus_active_id#tempus_}"

_themes() {
	# The parameter expansions here keep only the theme's unique name:
	# /path/to/tempus_classic.sh ==> classic
	while IFS= read -r -d $'\0' line; do
		line="${line##[a-z/_]*tempus_}"
		printf '%s\n' "${line%.sh}"
	done < <(find "$tempus_shell_files" -type f -name '*.sh' -print0 | sort -z)
}

# Notice the two caret signs `^': to upcase the expanded variable.
_rofi() {
	rofi -dmenu -no-custom -p "Select Tempus theme (current is ${tempus_active_id^^})"
}

selection="$(_themes | _rofi)"

[ -n "$selection" ] && tempus "$selection"
