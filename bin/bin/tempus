#!/usr/bin/env bash

# Choose among the Tempus themes
# ======================================================================

# Error handling and help messages
_help_message() {
	echo "Run this script with a single argument:"

	# The parameter expansions here keep only the theme's unique name:
	# /path/to/tempus_classic.sh ==> classic
	while IFS= read -r -d $'\0' line; do
		line="${line##[a-z/_]*tempus_}"
		printf '\t%s\n' "${line%.sh}"
	done < <(find "$HOME"/.local/share/my_colours/shell/ -type f -name '*.sh' -print0 | sort -z)

	echo "This assumes you have used STOW on my 'colours' directory (part of my dotfiles)"
}

if [ "$#" -ne 1 ]; then
	_help_message
	exit 1
fi

tempus_theme="$1"

# Is the theme light or dark?
case "$tempus_theme" in
	dawn | day | fugit | past | totus)
		theme_variant=light
		;;
	autumn | classic | dusk | future | night | rift | spring | summer | tempest | warp | winter)
		theme_variant=dark
		;;
	*)
		echo "_$1_ is not a valid Tempus theme."
		_help_message
		;;
esac

# Program-specific functions
# --------------------------

# Shorter version of the sed command we will be using throughout…
_sed() {
	gsed --follow-symlinks -i "$@" &
}

_sed_sync() {
	# Here we make an exception for the _sed function, because if we run
	# this asynchronously, other processes might fail to get the new
	# colours.  To my knowledge as of 2019-06-27, this appears to be
	# better than using sleep and/or until…
	gsed --follow-symlinks -i "$@"
}

# Check for dependency, else exit the given function that calls this.
_depcheck() {
	if ! command -v "$1" >/dev/null; then
		echo "Missing dependency: $1."
		return 1
	fi
}

_vim() {
	_depcheck vim

	cat <<-EOF >"$HOME/.vim/current_scheme"
		colorscheme tempus_$tempus_theme
	EOF
}

_x_and_shell() {
	tempus_files="$HOME/.local/share/my_colours"
	tempus_active_x="$tempus_files/active-theme.Xcolors"
	tempus_active_sh="$tempus_files/active-theme.sh"

	_check_tempus() {
		if [ -z "$1" ]; then
			echo "Path for Tempus themes is unavailable."
			return 1
		fi
	}

	ln -sf "${tempus_files}/shell/tempus_${tempus_theme}.sh" "$tempus_active_sh"
	ln -sf "${tempus_files}/xcolors/tempus_${tempus_theme}.Xcolors" "$tempus_active_x"

	repaint_terminals &

	[ -f "$HOME/.Xresources" ] && xrdb -merge "$HOME/.Xresources"
}

_emacs() {
	# Just switch to the appropriate Emacs theme.  The Modus themes are
	# not part of Tempus, but their goal is the same.
	#
	# See:
	#
	# 1. https://protesilaos.com/dotemacs
	# 2. https://gitlab.com/protesilaos/modus-themes
	case "$theme_variant" in
		l*) emacsclient -e "(prot/modus-operandi)" ;;
		d*) emacsclient -e "(prot/modus-vivendi)" ;;
	esac
}

_bspwm() {
	_depcheck bspwm

	pgrep -x bspwm || return 1

	_bc() {
		bspc config "$@"
	}

	_bc normal_border_color "$backgroundalt"
	_bc presel_feedback_color "$backgrounddim"
	if [ "$theme_variant" = 'light' ]; then
		_bc active_border_color "$color1"
		_bc focused_border_color "$color4"
	else
		_bc active_border_color "$color3"
		_bc focused_border_color "$color6"
	fi

	bspwm_colours="$HOME/.config/bspwm/bspwm_colours"

	if [ ! -f "$bspwm_colours" ]; then
		echo "Missing bspwm_colours"
		return 1
	fi

	case "$theme_variant" in
		l*)
			_sed "/^[^#].*active_border_color/ s,#[a-zA-Z0-9]*,$color1, ; \
            /^[^#].*focused_border_color/ s,#[a-zA-Z0-9]*,$color4, ; \
            /^[^#].*normal_border_color/ s,#[a-zA-Z0-9]*,$backgroundalt, ; \
            /^[^#].*presel_feedback_color/ s,#[a-zA-Z0-9]*,$backgrounddim," "$bspwm_colours"
			;;
		d*)
			_sed "/^[^#].*active_border_color/ s,#[a-zA-Z0-9]*,$color3, ; \
            /^[^#].*focused_border_color/ s,#[a-zA-Z0-9]*,$color6, ; \
            /^[^#].*normal_border_color/ s,#[a-zA-Z0-9]*,$backgroundalt, ; \
            /^[^#].*presel_feedback_color/ s,#[a-zA-Z0-9]*,$backgrounddim," "$bspwm_colours"
			;;
	esac
}

_tmux() {
	_depcheck tmux

	. "$HOME/.local/share/my_colours/active-theme.sh"

	cat <<-EOF >"$HOME/.tmux_colours.conf"
		tempus_fg=$foreground
		tempus_bg=$background
		tempus_fg_alt=$foregroundalt
		tempus_bg_alt=$backgroundalt
		tempus_bg_dim=$backgrounddim
	EOF

	tmux source-file ~/.tmux_colours.conf
	tmux source-file ~/.tmux.conf
}

# This is my script for adding content to lemonbar.  Reloading it will
# make it get the new shell colours.
_melonpanel() {
	_depcheck lemonbar-xft
	_depcheck melonpanel

    pkill -x bspc
    pkill -x lemonbar-xft
	pkill -f melonpanel
    melonpanel &
}

_wallpaper() {
	# the wallpapers are defined manually at
	# ~/pictures/theme/{light,dark}.jpg
	wall_path="$HOME/pictures/theme"
	wall_light="$wall_path/light.jpg"
	wall_dark="$wall_path/dark.jpg"

	[ -d "$wall_path" ] || {
		echo "No path to: $wall_path"
		return 1
	}
	[ -f "$wall_light" ] || {
		echo "No path to: $wall_light"
		return 1
	}
	[ -f "$wall_dark" ] || {
		echo "No path to: $wall_dark"
		return 1
	}

	_feh() {
		feh --bg-fill "$1" &
	}

	_depcheck feh
	case "$theme_variant" in
		l*)
			_feh "$wall_light"
			;;
		d*)
			_feh "$wall_dark"
			;;
	esac
}

_rofi() {
	_depcheck rofi

	roficonf="$HOME"/.config/rofi/config.rasi
	if [ -f "$roficonf" ]; then
		_sed "s/tempus_[a-z]*/tempus_${tempus_theme}/" "$roficonf"
	fi
}

# Function call cascade
# ---------------------
_x_and_shell
_emacs
_rofi
_tmux
_vim
_bspwm
_melonpanel
_wallpaper
