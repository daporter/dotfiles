#!/bin/sh
#
# Synchronise mail, including any pre- and post-sync hooks.

set -e

main() {
    presync
    sync
    postsync
}

presync() {
    hook="${HOME}/.mutt/hooks/presync.sh"
    if [ -x "$hook" ]; then
        $hook || {
            echo "Presync hook exited with status $?" 1>&2
            exit 1
        }
    fi
}

sync() {
    /usr/local/bin/mbsync everything || {
        echo "mbsync exited with status $?" 1>&2
        exit 1
    }
}

# Runs notmuch, lbdb-fetchaddr, etc.
postsync() {
    hook="$HOME/.mutt/hooks/postsync.sh"
    if [ -x "$hook" ]; then
        $hook || {
            echo "Postsync hook exited with status $?" 1>&2
            exit 1
        }
    fi
}

main
